<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.eatit.mapper.PurchaseMapper">
  
	  <!-- 테이블 데이터 매핑 -->
	  <resultMap type="com.eatit.businessDomain.ProductVO" id="productMap">
	  		<result property="product_no" column="product_no"/>
	  		<result property="product_code" column="product_code"/>
	  		<result property="product_name" column="product_name"/>
	  		<result property="product_category" column="product_category"/>
	  		<result property="product_category_detail" column="product_category_detail"/>
	  		<result property="company_no" column="company_no"/>
	  		<result property="product_unit" column="product_unit"/>
	  		<result property="product_price" column="product_price"/>
	  		<result property="expiry_date" column="expiry_date"/>

			<collection property="productList" resultMap="productMap"></collection>
	  </resultMap>

	  
	  <resultMap type="com.eatit.businessDomain.PurchaseVO" id="purchaseVO"/>
	  <resultMap type="com.eatit.memberDomain.MemberVO" id="memberVO"/>
	  <resultMap type="com.eatit.masterDataDomain.CompanyVO" id="companyVO"/>
	  
	  <!-- 발주서 작성 -->
	  <insert id="insertForm">
	  		INSERT INTO orders (company_no, employee_no, product_no, quantity, due_date, comments)
	  		VALUES (#{company_no}, #{employee_no}, #{product_no}, #{quantity}, #{due_date}, #{comments})
	  </insert>
	  
	  <!-- 내역 조회 -->
	  <select id="list" resultType="purchaseVO">
	  		<![CDATA[
	  		SELECT o.order_id, o.product_no, pi.product_name, o.quantity, o.order_date, o.order_status, c.company_name, c.company_tel
	  		FROM orders o
	  			JOIN company c ON o.company_no = c.company_no
	  			JOIN product_information pi ON o.product_no = pi.product_no
	  		WHERE delete_status = 0
	  		ORDER BY o.order_date DESC
	  		LIMIT #{startPage}, #{pageSize}
	  		]]>
	  </select>
	  
	  <!-- 주문 상세 조회 -->
	  <select id="selectOrder" resultType="purchaseVO">
	  		<![CDATA[
	  		SELECT o.*, pi.product_name, m.name, c.company_name, c.company_tel, c.company_address, c.company_address_detail
	  		FROM orders o
	  			JOIN product_information pi ON o.product_no = pi.product_no
	  			JOIN member m ON o.employee_no = m.employee_no
	  			JOIN company c ON o.company_no = c.company_no
	  		WHERE order_id = #{order_id}
	  		]]>
	  </select>
	  
	  <!-- 발주서 수정 -->
	  <update id="updateForm">
	  		UPDATE orders SET due_date = #{due_date}, comments = #{comments}, update_date = NOW()
	  		WHERE order_id = #{order_id} 
	  </update>
	  
	  <!-- 발주서 삭제 -->
	  <update id="deleteForm">
	  		UPDATE orders SET order_status = "취소", update_date = NOW(), delete_status = 1
	  		WHERE order_id = #{order_id}
	  </update>
	  
	  <!-- 전체 상품 조회 -->
	  <select id="productList" resultMap="productMap">
	  		SELECT *
	  		FROM product_information
	  </select>
	  
	  <!-- 검색 상품 조회 -->
	  <select id="searchProduct" resultMap="productMap">
	  		<![CDATA[
	  		SELECT *
	  		FROM product_information
	  		WHERE product_name LIKE CONCAT('%', #{query}, '%')
	  		]]>
	  </select>
	  
	  <!-- 상품 추가 -->
	  <select id="selectProduct" resultType="productVO">
	  		<![CDATA[
			SELECT *
	  		FROM product_information
	  		WHERE product_no = #{product_no}
	  		]]>
	  </select>	  

	  <!-- 회원 정보 조회 -->
	  <select id="readMember" resultMap="memberVO">
	  		<![CDATA[
	  		SELECT *
	  		FROM member
	  		WHERE id = #{id}	
	  		]]>
	  </select>	  
	  
	  <!-- 전체 거래처 조회 -->
	  <select id="getCompanyList" resultMap="companyVO">
	  		<![CDATA[
	  		SELECT *
	  		FROM company
	  		]]>
	  </select>	 
	  
	  <!-- 검색 거래처 조회 -->
	  <select id="searchCompany" resultMap="companyVO">
	  		<![CDATA[
	  		SELECT *
	  		FROM company
	  		WHERE company_name LIKE CONCAT('%', #{query}, '%')
	  		]]>
	  </select>	   
	  
	  <!-- 거래처 정보 조회 -->
	  <select id="getCompanyInfo" resultMap="companyVO">
	  		<![CDATA[
	  		SELECT *
	  		FROM company
	  		WHERE company_no = #{company_no}
	  		]]>
	  </select>	     
	  
	  <!-- 전체 신청 개수 -->
	  <select id="totalCount" resultType="int">
	  		<![CDATA[
	  		SELECT COUNT(*)
	  		FROM orders
	  		WHERE delete_status = 0
	  		]]>
	  </select>
  </mapper>